# 基于 VirtualBox 的网络攻防基础环境搭建

## 实验目的

- 掌握 VirtualBox 虚拟机的安装与使用；
- 掌握 VirtualBox 的虚拟网络类型和按需配置；
- 掌握 VirtualBox 的虚拟硬盘多重加载；

## 实验环境

本次实验需要使用的网络节点说明：

- VirtualBox 虚拟机
- 攻击者主机（Attacker）：Kali
- 网关（Gateway, GW）：Debian
- 靶机（Victim）：Debian / xp-sp3 / Kali

## 实验要求

- 虚拟硬盘配置成多重加载
- 搭建满足如下拓扑图所示的虚拟机网络拓扑；
- <img src="https://c4pr1c3.github.io/cuc-ns/chap0x01/attach/chap0x01/media/vb-exp-layout.png" style="zoom:50%;" />

- 完成以下网络连通性测试；
  - [x] 靶机可以直接访问攻击者主机
  - [x] 攻击者主机无法直接访问靶机
  - [x] 网关可以直接访问攻击者主机和靶机
  - [x] 靶机的所有对外上下行流量必须经过网关
  - [x] 所有节点均可以访问互联网
  
### 1.配置虚拟硬盘多重加载

- VirtualBox虚拟机首页 -> 管理 -> 虚拟介质管理
- 选中需要的虚拟盘，属性 -> 类型 修改为多重加载 -> 选择释放并应用
- 选中虚拟机 -> 设置 -> 存储 -> 控制器 添加虚拟硬盘
  
![Virtual hard disk multi-load interface 1](img/%E8%99%9A%E6%8B%9F%E7%A1%AC%E7%9B%98%E5%A4%9A%E9%87%8D%E5%8A%A0%E8%BD%BD.png)

![Virtual hard disk multi-load interface ](img/%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%B7%BB%E5%8A%A0%E8%99%9A%E6%8B%9F%E7%A1%AC%E7%9B%98.png)

### 2.搭建虚拟机网络拓扑

#### 根据拓扑结构配置所需网络

**网关debian-gateway** 设置4块网卡

- NAT网络，使网关可访问攻击者主机；
- 仅主机（Host-Only）网络，进行网卡设置；
- 内部网络intnet1，搭建局域网1；
- 内部网络intnet2，搭建局域网2。

![Gateway network card configuration](img/debian-gateway%E7%BD%91%E5%8D%A1%E8%AE%BE%E7%BD%AE.png)

**攻击者Kali-Attacker** 设置3块网卡

- NAT网络;
- 两块不同的Host-Only.

![Attacker network card configuration](img/Kali-Attacker%E7%BD%91%E5%8D%A1%E8%AE%BE%E7%BD%AE.png)

4台 **victim靶机** 分别在两个局域网内，仅需配置内部网络的一张网卡

- Kali-Victim-1和xp-Victim-1在局域网intnet1内
  
  ![Victim1](img/Victim%E7%BD%91%E5%8D%A1%E8%AE%BE%E7%BD%AE.png)

- xp-victim-2和debian-victim-2在局域网intnet2内
- ![Victim2](img/Victim%E7%BD%91%E5%8D%A1%E8%AE%BE%E7%BD%AE2.png)

### 3.连通性测试

| 节点               | ip地址         | 
| ------------------ | -------------- |
| Kali-Attacker      | 10.0.2.15      |
| Kali-Victim-1      | 172.16.111.124 |
| xp-Victim-1        | 172.16.111.145 |
| debian-Victim-2    | 172.16.222.123 |
| xp-Victim-2 | 169.254.3.136  |

#### 3.1靶机可以直接访问攻击者

> 网关使用了NAT模式。本实验中，靶机ping攻击者，ICMP Echo Request在经过网关时，网关会将src ip改为自己的外网IP。攻击者发回的ICMP Echo Reply在经过网关时，src ip又会被网关转换攻击者的IP，所以靶机看就是“能ping通攻击者”
- **局域网1内靶机可直接访问攻击者主机**

  ![The target machine can directly access the attacker's host](img/%E5%B1%80%E5%9F%9F%E7%BD%911%E5%86%85%E9%9D%B6%E6%9C%BA%E8%AE%BF%E9%97%AE%E6%94%BB%E5%87%BB%E8%80%85.png)

- **局域网2内靶机可直接访问攻击者主机**
  
  ![The target machine can directly access the attacker's host](img/%E5%B1%80%E5%9F%9F%E7%BD%912%E5%86%85%E9%9D%B6%E6%9C%BA%E8%AE%BF%E9%97%AE%E6%94%BB%E5%87%BB%E8%80%85.png)


#### 3.2攻击者主机无法直接访问靶机

> 靶机在内部局域网中使用的是虚拟ip地址，即仅内部网络可用的地址，除本局域网以外的机器访问是无效的，因此，攻击者无法对其进行访问。
- **攻击者无法直接访问局域网1内的靶机**

![The attacker cannot directly access the target machine in LAN 1](img/%E5%B1%80%E5%9F%9F%E7%BD%911%E6%94%BB%E5%87%BB%E8%80%85%E8%AE%BF%E9%97%AE%E9%9D%B6%E6%9C%BA.png)

- **攻击者无法直接访问语句网2内的靶机**

![The attacker cannot directly access the target machine in the data network 2](img/%E5%B1%80%E5%9F%9F%E7%BD%912%E6%94%BB%E5%87%BB%E8%80%85%E8%AE%BF%E9%97%AE%E9%9D%B6%E6%9C%BA.png)

#### 3.3网关可以直接访问攻击者主机和靶机

- **网关访问攻击者主机**

![Gateway access attacker host](img/%E7%BD%91%E5%85%B3%E8%AE%BF%E9%97%AE%E6%94%BB%E5%87%BB%E8%80%85.png)

- **网关访问局域网1内靶机**

![The gateway accesses the target machine in LAN 1](img/%E7%BD%91%E5%85%B3%E8%AE%BF%E9%97%AE%E5%B1%80%E5%9F%9F%E7%BD%911.png)

- **网关访问局域网2内靶机**

![Gateway access target machine in LAN 2](img/%E7%BD%91%E5%85%B3%E8%AE%BF%E9%97%AE%E5%B1%80%E5%9F%9F%E7%BD%912.png)

#### 3.4靶机的所有对外上下行流量必须经过网关

- 靶机与互联网互通的过程中**用网关抓包，若靶机发送的所有包都能被网关抓到**，说明靶机的所有对外上下行流量必须经过网关。
  - 网关抓包用tcpdump：输入命令`sudo tcpdump -c 5`
- **局域网1内的靶机**

![Target drone uplink and downlink traffic](img/%E7%BD%91%E5%85%B3%E6%8A%93%E5%8C%85%E5%B1%80%E5%9F%9F%E7%BD%911.png)

- **局域网2内的靶机**

![Target drone 2 uplink and downlink traffic](img/%E7%BD%91%E5%85%B3%E6%8A%93%E5%8C%85%E5%B1%80%E5%9F%9F%E7%BD%912.png)

- **利用tmux将抓包数据文件复制到主机用WireShark分析**

```shell
# 安装tcpdump
apt install tcpdump
apt update && apt install tmux
# 抓包
cd workspace
tcpdump -i enp0s9 -n -w 20210908.1.pcap
```

![Gateway capture traffic](img/%E7%BD%91%E5%85%B3%E6%8A%93%E5%8C%85.png)

抓包后的文件通过scp传送到本地在wireshark中进行分析，发现对应的ip数据均符合靶机和目标网址等信息，证明靶机的所有上过流量必须经过网关。



#### 3.5所有节点均可以访问互联网

- **网关可正常访问互联网**

![Gateway to the Internet](img/%E7%BD%91%E5%85%B3%E8%AE%BF%E9%97%AE%E4%BA%92%E8%81%94%E7%BD%91.png)

- **局域网1内的靶机可正常访问互联网**

![The target machine in LAN 1 accesses the Internet](img/%E5%B1%80%E5%9F%9F%E7%BD%911%E8%AE%BF%E9%97%AE%E4%BA%92%E8%81%94%E7%BD%91.png)

- **局域网2内的靶机可正常访问互联网**

![The target machine in LAN 2 accesses the Internet](img/%E5%B1%80%E5%9F%9F%E7%BD%912%E8%AE%BF%E9%97%AE%E4%BA%92%E8%81%94%E7%BD%91.png)

- **攻击者可正常访问互联网**

![attacker accesses the internet](img/%E6%94%BB%E5%87%BB%E8%80%85%E8%AE%BF%E9%97%AE%E4%BA%92%E8%81%94%E7%BD%91.png)

### 问题及解决方法
- 问题1：ssh登录时提示「permission denied please try again」
-  解决办法：
   - 输入命令`sudo vi /etc/ssh/sshd_config` 进入文件并将`#PermitRootLogin` 修改为 `PermitRootLogin yes`
   - 然后输入命令`service sshd restart` 重启sshd服务器

- 问题2：靶机无法访问到攻击者主机
- 解决办法：在全局设置中修改将网关和攻击者的`网络地址转换（NAT）网卡`修改为`NAT网络`
  
- 问题3：网关无法访问靶机
- 解决办法：将xp-Victim的防火墙关闭

### 参考文献
- [ssh登录时提示「permission denied please try again」](https://blog.csdn.net/donaldsy/article/details/102679413)
- [VSCODE连接虚拟机](https://blog.csdn.net/qq_29856169/article/details/115489702)
